### 柯里化表单校验小 demo 逐步拆解

下面按从“基础积木”到“业务使用”的顺序，拆解 `src/curry/curry-1.ts` 中的示例，帮助理解如何用柯里化预处理表单校验逻辑并实现复用与组合。

### 背景与目标

- **目标**: 通过柯里化先绑定“中文标签”“正则/阈值”等上下文，生成结构统一、便于组合复用的字段校验器。
- **收益**: 让“规则定义”更精简、可读；跨字段校验（如确认密码）也能轻松表达。

### 核心类型与组合器

- **FieldValidator 类型**
  - 定义: `type FieldValidator<TForm, TValue> = (value: TValue, form: TForm) => string | null`
  - 约定: 返回 `string` 表示错误消息，返回 `null` 表示通过。
- **composeValidators**
  - 作用: 顺序执行多个校验器，返回第一个错误；若全部通过，返回 `null`。
  - 意义: 把“规则声明”与“执行顺序”解耦，复合规则可读性更好。

### 基础校验器（通过柯里化预绑定上下文）

- **required(label)**: 绑定字段中文名，判断空值或空串。
- **minLength(label)(min)**: 先绑定标签，再绑定最小长度阈值。
- **pattern(label)(regex)(message)**: 先绑定标签，再绑定正则，最后绑定失败提示文案。
- **equalTo<TForm>(label)(otherLabel)(getOther)**
  - 用于跨字段一致性验证，如“确认密码 = 密码”。
  - `getOther(form)` 用于在运行时从整表单读取另一个字段的值。

这些函数使用“逐步返回函数”的形式，在“声明规则”时就把上下文固化下来，避免每次校验重复传参。

### 上下文工厂 withLabel

- **withLabel(label)**
  - 封装常用校验器的“标签绑定版”，并内置 email 正则：
    - `required`
    - `minLen(min)`
    - `pattern(regex, msg?)`
    - `email()`
  - 好处: 在业务层使用时只操作“规则”，不再关心基础校验器的细节和通用提示语。

### 业务模型与规则声明

- **表单模型**: `RegisterForm` 包含 `username`, `email`, `password`, `confirmPassword`。
- **标签实例**:
  - `const U = withLabel("用户名")`
  - `const E = withLabel("邮箱")`
  - `const P = withLabel("密码")`
  - `const C = withLabel("确认密码")`
- **规则组合 registerRules**
  - `username`: `required` → `minLen(3)`
  - `email`: `required` → `email()`
  - `password`: `required` → `minLen(6)`
  - `confirmPassword`: `required` → `equalTo("确认密码")("密码")((f) => f.password)`

通过 `composeValidators` 保证“先必填、再格式/长度、最后跨字段”的顺序。

### 表单校验入口 validateForm

- 输入整表单 `form`，依次取出每个字段的规则执行：
  - 执行单字段的组合校验器，得到第一条错误或 `null`。
  - 汇总到 `errors`，最终返回 `{ valid, errors }`。
- 语义：
  - `valid === true`: 所有字段都通过。
  - `errors`: 仅包含有错误的字段键值对，值为中文错误提示。

### 运行示例与输出

- `badForm` 会触发多处错误（用户名太短、邮箱格式、密码太短、确认密码不一致）。
- `goodForm` 会全部通过。
- 控制台打印：
  - `bad => { valid: false, errors: {...} }`
  - `good => { valid: true, errors: {} }`

### 如何扩展（建议）

- **新增字段规则**: 在 `withLabel` 中新增工厂，如手机号 `mobile()`、身份证 `idCard()` 等。
- **异步校验**: 将 `FieldValidator` 扩展为返回 `Promise<string | null>` 的版本，或单独定义 `AsyncFieldValidator`。
- **跨字段依赖**: 模式与 `equalTo` 一致，封装 `getOther(form)` 即可。
- **国际化**: 将提示文案透传参数或集中到 message map 中，便于切换语言。

### 快速使用清单

- 定义表单类型 `TForm`。
- 用 `withLabel("中文名")` 为每个字段生成工厂。
- 用 `composeValidators(...rules)` 声明字段规则。
- 使用 `validateForm(form)` 得到 `{ valid, errors }`。

——

// todo
手机号/异步校验的代码骨架
